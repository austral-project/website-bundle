services:
  _defaults:
    autowire:      true
    autoconfigure: true
    public:        true

##### Website Event Subscriber Kernel
  austral.website.redirect.event_subscriber:
    class:        Austral\WebsiteBundle\EventSubscriber\WebsiteRedirectSubscriber
    arguments:    ["@austral.website.handler"]
    tags:
      - { name: kernel.event_subscriber }

  austral.website.http.event_subscriber:
    class:        Austral\WebsiteBundle\EventSubscriber\HttpWebsiteEventSubscriber
    arguments:    [ "@service_container", "@austral.website.config", "@austral.http.domains.management", "@austral.tools.debug" ]
    tags:
      - { name: kernel.event_subscriber }


##### Website Listener

  austral.website.doctrine.listener:
    class:        Austral\WebsiteBundle\Listener\DoctrineListener
    tags:
      - { name: doctrine.event_subscriber, connection: default }


  austral.website.entity_manager.listener:
    class:        Austral\WebsiteBundle\Listener\EntityManagerListener
    arguments:    ["@austral.entity_manager.page"]
    tags:
      - { name: kernel.event_listener, event: "austral.entity_manager.duplicate", method: duplicate }

##### Website Handler
  austral.website.handler:
    class:        App\Handler\WebsiteHandler
    arguments:
      - "@service_container"
      - "@request_stack"
      - "@event_dispatcher"
      - "@austral.tools.debug"
    calls:
      - [ setMercure, [ "@?austral.notify.mercure" ] ]
      - [ setConfigVariable, [ "@austral.website.config_variable" ] ]

##### Website Template
  austral.website.template:
    class:        Austral\WebsiteBundle\Template\TemplateParameters

##### Website Services
  austral.website.config_variable:
    class:          Austral\WebsiteBundle\Services\ConfigVariable
    arguments:      ["@request_stack",  "@austral.http.domains.management", "@doctrine.orm.entity_manager", "@austral.entity_file.link.generator"]

  austral.website.config_replace_dom:
    class:          Austral\WebsiteBundle\Services\ConfigReplaceDom
    arguments:      ["@austral.website.config_variable", "@austral.http.domains.management", "@austral.seo.url_parameter.management", "@router"]

##### Entities Manager #####

  ##### Config Entity Manager
  austral.entity_manager.config:
    class:          Austral\WebsiteBundle\EntityManager\ConfigEntityManager
    arguments:      [ "@doctrine.orm.entity_manager",  "@event_dispatcher", "%austral.entity.config.class%" ]

  ##### Page Entity Manager
  austral.entity_manager.page:
    class:          Austral\WebsiteBundle\EntityManager\PageEntityManager
    arguments:      [ "@doctrine.orm.entity_manager",  "@event_dispatcher", "%austral.entity.page.class%" ]

  ##### Tracking Entity Manager
  austral.entity_manager.tracking:
    class:          Austral\WebsiteBundle\EntityManager\TrackingEntityManager
    arguments:      [ "@doctrine.orm.entity_manager",  "@event_dispatcher", "%austral.entity.tracking.class%" ]

##### Parameters #####
  austral.website.config:
    class:          Austral\WebsiteBundle\Configuration\WebsiteConfiguration
    arguments:      ["%austral_website_config%"]

##### Form Type #####
  austral.website.config_value_by_domain.form_type:
    class:        Austral\WebsiteBundle\Form\Type\ValueByDomainFormType
    arguments:    [ "@security.authorization_checker" ]
    tags:
      - { name: form.type , alias: austral_config_value_by_domain_form_type }
